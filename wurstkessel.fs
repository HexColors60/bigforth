\ Wurstkessel data from www.random.org

Create rngs
$EA576B15A7AFBA08. 2, $BF4888DC02131EF7. 2, $5F49A40B1DAAF5FD. 2, $7798975E5233C89D. 2, 
$A70A1BD518B3FBC6. 2, $8E31D54ECB7BCDF9. 2, $949D107029F94EAA. 2, $7B40261F6B3E0763. 2, 
$E845F90477A30AC5. 2, $6BF5CDC094B7A657. 2, $B0796C9F61F990F9. 2, $C149FABA50014BFC. 2, 
$626377228BC762EF. 2, $639BFE93094E7B84. 2, $0B61140C13513E15. 2, $ADB800460D8B7A3F. 2, 
$20D3873110880D43. 2, $144B862F4755D8EF. 2, $69C127F350ECD709. 2, $4A92511FAD31D465. 2, 
$34EB0EF8ED8230B2. 2, $477BF466E332DDB8. 2, $086B6F20DC2F1B33. 2, $E020C8012E1EBC4A. 2, 
$C4A5BEF939044AFC. 2, $C5C5B03F80FAF739. 2, $AD46EFBA6E4EEFB2. 2, $EAD04EEF21AD5CCA. 2, 
$68516345F32E582E. 2, $FEDE2067A335B1F6. 2, $96611D13172BA044. 2, $1DDBC3F36257DF96. 2, 
$4BFE75A91B582D07. 2, $82DF3A7D4205D9B4. 2, $CDC7C2C769B10163. 2, $2B9EFB3A406C1C22. 2, 
$DA732F17BB5FA819. 2, $14DA2D994B88EBFB. 2, $E9E8DA371866818E. 2, $6AAFEAAB80D72758. 2, 
$E2453ACEA74719DB. 2, $62CAB78E82137E78. 2, $4B60E6778A84C82B. 2, $41BF2417B0070764. 2, 
$F3865ADEBF337A99. 2, $A1EC36C696492BE0. 2, $7C884B32080C649F. 2, $AAE99BDADC37685A. 2, 
$DCA4C59D98BEEC6C. 2, $DD8886FED8B82090. 2, $F894AA6994EFDB8A. 2, $FB954EA7107B1BF3. 2, 
$80E569581773CF5F. 2, $F418E1F97E601D94. 2, $7A9B9F9033A40820. 2, $00E06D7C4F50726B. 2, 
$19C205C7F461EB65. 2, $DB610A36DE40AE7C. 2, $0FCD201AF3E65F5F. 2, $5840910FC1902224. 2, 
$1210975240BE1829. 2, $71B97307E8E903F9. 2, $DF85C6C346DF4FF2. 2, $BB26F835FD3711F1. 2, 
$4DE8E6DC008BD249. 2, $8C11D5A647CA6231. 2, $B10D0F66EC07A251. 2, $D2D4C7BD608AACDE. 2, 
$17C7560D621E6D62. 2, $A182591BC53D7C8A. 2, $8FBF7260C16058D7. 2, $D20C1AA47AD280FD. 2, 
$4C34ABC646276D3E. 2, $DF9328222B555885. 2, $5FCEAC68B91AA75F. 2, $B662C4D84F7135C6. 2, 
$418DBD3C45D7E67C. 2, $5E07DB97A28D2A3A. 2, $D5D7B024C7E148A3. 2, $3F3023639E4ED91D. 2, 
$75590580D18BDCF7. 2, $2936C445A8CCE5D3. 2, $1C9B51352A9B38AA. 2, $1EC67B0E63EA6B9C. 2, 
$30AA42F444DD8D77. 2, $5490C75F1A50B3D4. 2, $8A62DC6866149DC6. 2, $45E71CA58A3A1A03. 2, 
$44C35A60CA62EF4C. 2, $8A8D10F67904F203. 2, $73FB47C99A789E27. 2, $F6DA264C5EC58834. 2, 
$7DE707AB941A68B1. 2, $8E5FC15AB1B82D42. 2, $169F270E31E118B9. 2, $89D77D2CA228F1A1. 2, 
$F73BFCD076EA4593. 2, $3FC2594EA868AA6B. 2, $7E712B3826BF940B. 2, $C5E47523F2ED72D3. 2, 
$B17D5E2B40D91CB7. 2, $7A46CA989B6B545C. 2, $DF53963473D8A028. 2, $1C2B05E95B6A2361. 2, 
$2A8CE6CC8AA46240. 2, $7E56673B8467B2D4. 2, $5CC08986DD1643D2. 2, $34BEC26C10A8A0F7. 2, 
$5A1065508344D9BF. 2, $964CD691C7514A54. 2, $DA6642E206D8EEC0. 2, $FE50640EACC57736. 2, 
$4FD775BEEC03E00C. 2, $2ED51322FA648470. 2, $D126396FE346FD82. 2, $321F8E62660A5358. 2, 
$B18AC0415120A970. 2, $AE66E8D0D89BDEA2. 2, $8FF3907042113713. 2, $3ED1A5AF45B9BD21. 2, 
$CD93C5A7676F9B80. 2, $B6390A3D94DAEF11. 2, $868976715C5CCA68. 2, $AD886AA064B5DDC5. 2, 
$DCD8A0CCB0EE4F42. 2, $5E825B5AF2696B48. 2, $C6AD2848B1BD2AFE. 2, $4DE5A20AD330B6E4. 2, 
$121DA3E4428AA27D. 2, $AD734AF69BB658E8. 2, $A239809834B66FEC. 2, $4E0AFF25C162024C. 2, 
$12ADAB1B8CDBAA49. 2, $7EFD205B8A2D7142. 2, $1100D36951CC6ACD. 2, $56D7D5D9087D42DC. 2, 
$19BE8F3D1D7A103F. 2, $587697A07337E076. 2, $F134983D796333BF. 2, $8A67B4F38C5624C5. 2, 
$5D8A9736AD2EEDE3. 2, $5C32F0C1D2E26BED. 2, $029AD86080A1960A. 2, $ED5F76D1DB276ED9. 2, 
$33CB581061805DFD. 2, $A5DF2522A0F691C7. 2, $A4ADEDF782FD6BD2. 2, $FE384FF0D371C964. 2, 
$F5CFEF9E4A4CD273. 2, $85CBBAC869401C81. 2, $D511B713FED7005B. 2, $A7611177D696F186. 2, 
$CB2BE1FFA608F675. 2, $25031046C85C4651. 2, $607171BC4577D270. 2, $A7BD8884299863A6. 2, 
$BB09FB728099A1E0. 2, $257145E566C8698F. 2, $656BDB6B9184535F. 2, $2682AAE2CA83AE91. 2, 
$F7A44CC4003AAEE0. 2, $888A9A9370DA460A. 2, $6DE1F7FCFF64A895. 2, $B998294B6E631726. 2, 
$DD10FD0E373DE174. 2, $A4A1C99E1EDFF788. 2, $ABF89C5C23965C8C. 2, $519FCEACDB50A42E. 2, 
$C87EE06B04A3EE27. 2, $B3B84836F52EFE4A. 2, $6771855FC5488FF2. 2, $029F27357BF79A7B. 2, 
$864E931EC02D2201. 2, $9DFA41C069A2BEEE. 2, $22A5DB4B50464091. 2, $B0D2E299A7808724. 2, 
$FFC352ACC4E06CD6. 2, $9578BEBB4DB8FC2F. 2, $DC6E349B2D6DA548. 2, $2094DAB6C646C2D7. 2, 
$3B0AF3D2FD8EF1D0. 2, $63FDE78F2E0FB634. 2, $1C99503BC604F097. 2, $1C1EF3E82C9FC053. 2, 
$6BDB8E76017C181A. 2, $26D88404B8CBAFAE. 2, $187366AF04471F8D. 2, $76A2778F66E512B8. 2, 
$E5BA2951AF211F80. 2, $86B065507B33F205. 2, $75E3B0DFDD17BE98. 2, $09EDA77B60ABFE0A. 2, 
$97BEA04E8FA350FC. 2, $BC6E641D8A5D1A28. 2, $46D6377D5FB77C8D. 2, $3F97A7C23285D9E4. 2, 
$BA50164CA926C25D. 2, $CCDB57813E220451. 2, $1C967F121B63DDDF. 2, $A2A840B2E56CA3BD. 2, 
$00787A81DB69A851. 2, $AB7BE835BFC19FE8. 2, $C35A18B6E11A9F05. 2, $F4FAD3C269CEA995. 2, 
$C52B4F9FB5F7EB87. 2, $BF066890B494DF0E. 2, $E665E54BD57BF07D. 2, $9F662650E1CAA8B3. 2, 
$B60FCBB205E1B3D4. 2, $21D47F05B16CEE46. 2, $A7706D9DA4D36B31. 2, $23028D1C88657839. 2, 
$E0F3BE98C0D8E92E. 2, $9DA5D5CDED8C4DA2. 2, $827109BFA754CEA4. 2, $435571F88E42BC1F. 2, 
$3CE06094CBB9EFCB. 2, $2C03447D95B00977. 2, $D3E63B65D96A3686. 2, $A50C72D7437BC7FE. 2, 
$5737E476389CA9FD. 2, $3C8F8495ED9FB6BB. 2, $7E66BF01BDDE8AC9. 2, $42FF650C947F1B73. 2, 
$831AD4C01A37458A. 2, $AB86296924F9D44E. 2, $D04534934527FE11. 2, $AD67B18D326BA056. 2, 
$CDC85BC218E596C3. 2, $97536CD65082A588. 2, $41838111A37C89B5. 2, $1E670AC7A5905648. 2, 
$7EB67D2636ADEDF6. 2, $0560514F780DD13E. 2, $8B78A94B6C990708. 2, $7C15977BA8EA6213. 2, 
$8C8E898D35F895FE. 2, $1A2CA8EE917F324B. 2, $2CD3067B1262A84D. 2, $169C0956D6011241. 2, 
$3213F9193BDB3C69. 2, $7BC2F0864E7C480E. 2, $539F82006AB05B2C. 2, $D684DD5C69A76F73. 2, 
$168A44E4E0FA0504. 2, $42A75FDDE3BA8C01. 2, $FB48A92AE2DAD4D1. 2, $86121899DC7429C7. 2, 
$10F72AA5B40A344A. 2, $E4926B1781F8C90C. 2, $4F4C3F28EDAD7518. 2, $744C57C4DB14A013. 2, 
$450FC24B306136AE. 2, $DBE8614B7E18115C. 2, $A4CD66811B0F87FC. 2, $31984500099D06F5. 2, 
here rngs -
DOES> swap 2* cells + 2@ ;
constant rng-size

\ wurstkessel algorithm

8 2* cells Constant state#

Create source    state# allot
Create state     state# allot
Create nextstate state# allot

[IFDEF] Code
    Code d+c ( ud1 ud2 -- ud3 )
	DX pop  CX pop  DX SP ) add  CX AX adc  0 # SP ) adc  0 # AX adc
	Next end-code macro
[ELSE]
    : d+c ( ud1 ud2 -- ud3 )  rot 0 tuck d+ >r >r 0 tuck d+ 0 r> 0 d+ r> + 0 d+ ;
[THEN]

: mix2bytes ( index n k -- b1 .. b8 index' n ) state + 8 0 DO
	>r over source + c@ r@ c@ xor -rot dup >r + $3F and r> r> 8 + LOOP
    drop ;

: bytes2sum ( b1 .. b8 -- ud ) >r >r >r >r  >r >r >r >r
    r> rngs      r> rngs d+c  r> rngs d+c  r> rngs d+c
    r> rngs d+c  r> rngs d+c  r> rngs d+c  r> rngs d+c ;

Create round#  1 , 3 , 7 , 13 , 19 , 23 , 31 , 47 ,
DOES> swap 7 and cells + @ ;

: round ( n -- ) dup 1- swap  8 0 DO
	I mix2bytes 2>r bytes2sum 2r> 2swap nextstate I 2* cells + 2!
    LOOP 2drop  nextstate state state# move ;

: rounds ( n -- )  0 ?DO  I round# round  LOOP ;

: .16 ( ud -- ) base push hex <# 16 0 DO # LOOP #> type ;

: .state  ( -- ) 8 0 DO  state  I 2* cells + 2@ .16  LOOP ;
: .source ( -- ) 8 0 DO  source I 2* cells + 2@ .16  LOOP ;

\ wurstkessel file functions

0 Value wurst-in
0 Value wurst-out

: wurst-file ( addr u -- )   r/o open-file throw to wurst-in ;

: size? ( -- ud )
    wurst-in file-size throw ;

: wurst-outfile ( addr u -- )  w/o create-file throw to wurst-out ;

\ wurstkessel hash

Create source-init
$6C5F6F6CBE627172. 2, $7164C30603661C2E. 2, $CE5009401B441346. 2, $454FA335A6E63AD2. 2,
$ABE9D0D648C15F6E. 2, $B90FD4060D7935D6. 2, $F7EDA8E2E8D6CB32. 2, $6230D90DBE8E061B. 2,

Create state-init
$FEC967C32E46440F. 2, $3F63157E14F89982. 2, $F7364A7F8083EFFA. 2, $FC62572A44559951. 2,
$9915714DB7397949. 2, $AE4180D53650E38C. 2, $C53813781DFF0C2E. 2, $A579435502F22741. 2,

: hash-init
    source-init source state# move
    state-init  state state# move
    size? source 2!  0. source 2 cells + 2! ;

: wurst-hash ( rounds -- )  hash-init
    source state# 4 cells /string wurst-in read-file throw  4 cells +  over rounds
    BEGIN  state# =  WHILE
	    source state# erase  source state# wurst-in read-file throw
	    over rounds  REPEAT
    drop .state ;

\ wurstkessel encryption

Create wurst-key
$20799FEC4B2E86C7. 2, $9F5454CDBDF51F76. 2, $EE1905FFF4B24C3D. 2, $9841F78BA1E0A3B7. 2,
$B6C33E39C326A161. 2, $FD4E8C0EAA7C4362. 2, $839E0910FFD9401A. 2, $2785F5C10D610C68. 2,
Create wurst-salt
$39A157A31F7D62BC. 2, $51C3BD3BA4F4F803. 2, $21D7D0ED16A5243A. 2, $3C80195D8D80874F. 2,
$6DF5EF6205D55E03. 2, $8859C59812F47028. 2, $F7795F00874ACED7. 2, $5FBE66944DBECB7F. 2,

Create message    state# allot

: xormsg ( -- )  16 0 DO
    message Ith state Ith xor message I cells + !  LOOP ;

: .xormsg ( -- )  xormsg
    message state# wurst-out write-file throw ;

: encrypt-init ( -- )
    wurst-key   state  state# move
    wurst-salt  source state# move
    wurst-salt  state# wurst-out write-file throw ;

: encrypt-size ( -- remain )
    size? message 2!  0. message 2 cells + 2!
    message state# 4 cells /string wurst-in read-file throw ;

: encrypt-read ( -- )
    message state# erase  message state# wurst-in read-file throw ;

: +entropy ( -- )
    message source state# move ;

: wurst-encrypt ( rounds -- )  encrypt-init
    encrypt-size  4 cells + over rounds
    BEGIN
	+entropy  .xormsg  state# =  WHILE
	    encrypt-read  over rounds  REPEAT
    drop ;

: decrypt-init ( -- )
    wurst-key   state  state# move
    source state# wurst-in read-file throw drop ;

2Variable outsize

: .xormsg-size ( -- )  xormsg
    message 2@ outsize 2!
    message state# 4 cells /string
    0 outsize 2@ dmin outsize 2@ 2over d- outsize 2! drop
    wurst-out write-file throw ;

: .xormsg' ( -- )  xormsg
    message state#
    0 outsize 2@ dmin outsize 2@ 2over d- outsize 2! drop
    wurst-out write-file throw ;

: wurst-decrypt ( rounds -- )  decrypt-init
    encrypt-read
    over rounds .xormsg-size
    +entropy
    BEGIN  state# =  WHILE
	encrypt-read
	over rounds .xormsg'
	+entropy  REPEAT
    drop ;

\ wurstkessel rng

: rng-init
    wurst-salt  source state# move
    state-init  state  state# move ;

: wurst-rng ( rounds -- )
    2 0 DO  dup rounds
	source    state  state# move
	nextstate source state# move
    LOOP  drop ;
